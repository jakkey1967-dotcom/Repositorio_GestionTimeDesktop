<Page
    x:Class="GestionTime.Desktop.Views.ParteItemEdit"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:helpers="using:GestionTime.Desktop.Helpers"
    mc:Ignorable="d"
    Background="Transparent">

    <!-- ===================== THEME + PALETA ===================== -->
    <Page.Resources>
        <ResourceDictionary>

            <ResourceDictionary.ThemeDictionaries>

                <!-- OSCURO -->
                <ResourceDictionary x:Key="Default">
                    <SolidColorBrush x:Key="AppBgFallback" Color="#0F1113"/>
                    <ImageBrush x:Key="AppBg" ImageSource="ms-appx:///Assets/diario_bg_dark.png" Stretch="UniformToFill" AlignmentX="Center" AlignmentY="Center" Opacity="1"/>
                    <SolidColorBrush x:Key="SurfaceBg" Color="#1A1D21"/>
                    <SolidColorBrush x:Key="Stroke" Color="#30363D"/>
                    <SolidColorBrush x:Key="TextMain" Color="#EDEFF2"/>
                    <SolidColorBrush x:Key="TextMuted" Color="#A8B0B8"/>
                    <SolidColorBrush x:Key="Accent" Color="#0B8C99"/>
                    <SolidColorBrush x:Key="AccentDark" Color="#08707A"/>
                    <SolidColorBrush x:Key="CardBg" Color="#121416"/>
                    <SolidColorBrush x:Key="InputBg" Color="#0B8C99"/>
                    <SolidColorBrush x:Key="InputText" Color="#FFFFFF"/>
                    <SolidColorBrush x:Key="ButtonBg" Color="#1E2328"/>
                    <SolidColorBrush x:Key="ButtonStroke" Color="#30363D"/>
                    <SolidColorBrush x:Key="BannerBg" Color="#0B8C99"/>
                    <BitmapImage x:Key="LogoImage" UriSource="ms-appx:///Assets/LogoOscuro.png"/>
                </ResourceDictionary>

                <!-- CLARO -->
                <ResourceDictionary x:Key="Light">
                    <SolidColorBrush x:Key="AppBg" Color="#F5F7F9"/>
                    <ImageBrush x:Key="AppBgImage" ImageSource="ms-appx:///Assets/Diario_bg_claro.png" Stretch="UniformToFill" AlignmentX="Center" AlignmentY="Center" Opacity="1"/>
                    <SolidColorBrush x:Key="SurfaceBg" Color="#FFFFFF"/>
                    <SolidColorBrush x:Key="Stroke" Color="#D6DEE6"/>
                    <SolidColorBrush x:Key="TextMain" Color="#111315"/>
                    <SolidColorBrush x:Key="TextMuted" Color="#5A6B74"/>
                    <SolidColorBrush x:Key="Accent" Color="#0B8C99"/>
                    <SolidColorBrush x:Key="AccentDark" Color="#08707A"/>
                    <SolidColorBrush x:Key="CardBg" Color="#FFFFFF"/>
                    <SolidColorBrush x:Key="InputBg" Color="#0B8C99"/>
                    <SolidColorBrush x:Key="InputText" Color="#FFFFFF"/>
                    <SolidColorBrush x:Key="ButtonBg" Color="#F3F6F9"/>
                    <SolidColorBrush x:Key="ButtonStroke" Color="#D6DEE6"/>
                    <SolidColorBrush x:Key="BannerBg" Color="#0B8C99"/>
                    <BitmapImage x:Key="LogoImage" UriSource="ms-appx:///Assets/LogoClaro.png"/>
                </ResourceDictionary>

            </ResourceDictionary.ThemeDictionaries>

            <Style TargetType="TextBlock">
                <Setter Property="Foreground" Value="{ThemeResource TextMain}"/>
            </Style>

            <Style x:Key="MutedText" TargetType="TextBlock">
                <Setter Property="Foreground" Value="{ThemeResource TextMuted}"/>
            </Style>

            <Style x:Key="PanelBorder" TargetType="Border">
                <Setter Property="Background" Value="{ThemeResource CardBg}"/>
                <Setter Property="BorderBrush" Value="{ThemeResource Stroke}"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="CornerRadius" Value="10"/>
            </Style>

            <Style x:Key="FieldLabel" TargetType="TextBlock">
                <Setter Property="FontSize" Value="12"/>
                <Setter Property="FontWeight" Value="Normal"/>
                <Setter Property="Foreground" Value="{ThemeResource TextMuted}"/>
                <Setter Property="Margin" Value="0,0,8,0"/>
                <Setter Property="VerticalAlignment" Value="Center"/>
            </Style>

            <Style x:Key="FieldTextBox" TargetType="TextBox">
                <Setter Property="Background" Value="{ThemeResource InputBg}"/>
                <Setter Property="Foreground" Value="{ThemeResource InputText}"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="CornerRadius" Value="4"/>
                <Setter Property="Padding" Value="10,6"/>
                <Setter Property="FontSize" Value="13"/>
                <Setter Property="Height" Value="32"/>
                <Setter Property="VerticalAlignment" Value="Center"/>
            </Style>

            <Style x:Key="FieldComboBox" TargetType="ComboBox">
                <Setter Property="Background" Value="{ThemeResource InputBg}"/>
                <Setter Property="Foreground" Value="{ThemeResource InputText}"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="CornerRadius" Value="4"/>
                <Setter Property="Height" Value="32"/>
                <Setter Property="VerticalAlignment" Value="Center"/>
            </Style>

            <Style x:Key="ToolbarButton" TargetType="Button">
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="BorderBrush" Value="{ThemeResource Accent}"/>
                <Setter Property="Width" Value="80"/>
                <Setter Property="Height" Value="70"/>
                <Setter Property="Padding" Value="8"/>
                <Setter Property="CornerRadius" Value="6"/>
            </Style>

            <Style x:Key="ThemeButton" TargetType="Button">
                <Setter Property="Background" Value="{ThemeResource SurfaceBg}"/>
                <Setter Property="BorderBrush" Value="{ThemeResource Stroke}"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="CornerRadius" Value="8"/>
                <Setter Property="Padding" Value="10,8"/>
            </Style>

        </ResourceDictionary>
    </Page.Resources>

    <!-- ===================== LAYOUT ===================== -->
    <Grid x:Name="RootGrid" 
          Background="{ThemeResource AppBg}" 
          Padding="10" 
          RowSpacing="10"
          Opacity="0">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- ===================== BANNER (logo + título + info usuario) ===================== -->
        <Border Grid.Row="0" Background="{ThemeResource BannerBg}" CornerRadius="10" Padding="16">
            <Grid ColumnSpacing="16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <!-- Logo -->
                <Border Grid.Column="0" Background="Transparent" CornerRadius="6" VerticalAlignment="Center">
                    <Image x:Name="LogoImageBanner" 
                           Source="ms-appx:///Assets/LogoOscuro.png" 
                           Stretch="Uniform"
                           MaxHeight="60"
                           HorizontalAlignment="Left"/>
                </Border>
                
                <!-- Título + Info de Usuario -->
                <StackPanel Grid.Column="1" 
                            VerticalAlignment="Center" 
                            Spacing="4"
                            Margin="8,0,0,0">
                    <!-- Título Principal con Estado -->
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <TextBlock x:Name="TxtTituloParte" 
                                   Text="Editar Parte"
                                   FontSize="22"
                                   FontWeight="SemiBold"
                                   Foreground="White"/>
                        <!-- Badge de Estado -->
                        <Border x:Name="BadgeEstado"
                                Background="#10B981"
                                CornerRadius="12"
                                Padding="12,4"
                                VerticalAlignment="Center">
                            <TextBlock x:Name="TxtEstadoParte" 
                                       Text="Abierto"
                                       FontSize="12"
                                       FontWeight="SemiBold"
                                       Foreground="White"/>
                        </Border>
                    </StackPanel>
                    
                    <!-- Usuario -->
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE77B;" 
                                  FontSize="14" 
                                  Foreground="White" 
                                  Opacity="0.9"
                                  VerticalAlignment="Center"/>
                        <StackPanel Spacing="2">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock x:Name="TxtUserName" 
                                           Text="Usuario"
                                           FontSize="14"
                                           FontWeight="SemiBold"
                                           Foreground="White"/>
                                <TextBlock Text="•" 
                                           FontSize="14"
                                           Foreground="White"
                                           Opacity="0.6"/>
                                <TextBlock x:Name="TxtUserRole" 
                                           Text="Usuario"
                                           FontSize="14"
                                           FontWeight="SemiBold"
                                           Foreground="White"
                                           Opacity="0.9"/>
                            </StackPanel>
                            <TextBlock x:Name="TxtUserEmail" 
                                       Text="usuario@empresa.com"
                                       FontSize="12"
                                       Foreground="White"
                                       Opacity="0.8"/>
                        </StackPanel>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Contenido del formulario -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="20,12">
            <StackPanel Spacing="10" MaxWidth="1600">

                <!-- Fila 1: Fecha | Cliente | Tienda -->
                <Grid ColumnSpacing="8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="180"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="350"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" Text="Fecha" Style="{StaticResource FieldLabel}"/>
                    <CalendarDatePicker Grid.Column="1" 
                                        x:Name="DpFecha"
                                        Background="{ThemeResource InputBg}"
                                        Foreground="{ThemeResource InputText}"
                                        BorderThickness="0"
                                        CornerRadius="4"
                                        Height="32"
                                        VerticalAlignment="Center"
                                        TabIndex="1"
                                        DateFormat="{}{day.integer}/{month.integer}/{year.full}"
                                        DateChanged="OnFieldChanged"/>
                    
                    <TextBlock Grid.Column="2" Text="Cliente" Style="{StaticResource FieldLabel}"/>
                    <AutoSuggestBox Grid.Column="3" 
                                    x:Name="TxtCliente"
                                    Background="{ThemeResource InputBg}"
                                    Foreground="{ThemeResource InputText}"
                                    BorderThickness="0"
                                    CornerRadius="4"
                                    Height="32"
                                    MinWidth="350"
                                    TabIndex="2"
                                    PlaceholderText="Escriba para buscar cliente..."
                                    TextChanged="OnClienteTextChanged"
                                    SuggestionChosen="OnClienteSuggestionChosen"
                                    QuerySubmitted="OnClienteQuerySubmitted"/>
                    
                    <TextBlock Grid.Column="4" Text="Tienda" Style="{StaticResource FieldLabel}"/>
                    <TextBox Grid.Column="5"
                             x:Name="TxtTienda" 
                             Style="{StaticResource FieldTextBox}"
                             MinWidth="350"
                             TabIndex="3"
                             TextChanged="OnFieldChanged"/>
                    <Button Grid.Column="6"
                            Background="{ThemeResource InputBg}"
                            BorderThickness="0"
                            CornerRadius="4"
                            Width="32"
                            Height="32"
                            Padding="0"
                            Visibility="Collapsed"
                            IsTabStop="False"
                            Margin="8,0,0,0">
                        <!-- IconHelper.Person -->
                        <FontIcon Glyph="&#xE77B;" FontSize="16" Foreground="White"/>
                    </Button>
                    <Button Grid.Column="7"
                            Background="{ThemeResource InputBg}"
                            BorderThickness="0"
                            CornerRadius="4"
                            Width="32"
                            Height="32"
                            Padding="0"
                            Visibility="Collapsed"
                            IsTabStop="False"
                            Margin="8,0,0,0">
                        <!-- IconHelper.Add -->
                        <FontIcon Glyph="&#xE710;" FontSize="16" Foreground="White"/>
                    </Button>
                </Grid>

                <!-- Fila 2: Hora ini. | Hora fin. | Nº Ticket | Grupo | Tipo | Duración -->
                <Grid ColumnSpacing="4">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>   <!-- Label Hora ini -->
                        <ColumnDefinition Width="60"/>     <!-- Hora inicio (6 caracteres) -->
                        <ColumnDefinition Width="Auto"/>   <!-- Label Hora fin -->
                        <ColumnDefinition Width="60"/>     <!-- Hora fin (6 caracteres) -->
                        <ColumnDefinition Width="Auto"/>   <!-- Label Ticket -->
                        <ColumnDefinition Width="120"/>    <!-- Ticket (10 caracteres) -->
                        <ColumnDefinition Width="Auto"/>   <!-- Label Grupo -->
                        <ColumnDefinition Width="120"/>    <!-- Grupo (30 caracteres) -->
                        <ColumnDefinition Width="Auto"/>   <!-- Label Tipo -->
                        <ColumnDefinition Width="120"/>  <!-- Tipo (30 caracteres) -->
                        <ColumnDefinition Width="Auto"/>   <!-- Label Duración -->
                        <ColumnDefinition Width="80"/>     <!-- Duración (5 caracteres) -->
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" 
                               Text="Hora ini." 
                               Style="{StaticResource FieldLabel}"
                               Margin="0,0,4,0"/>
                    <TextBox Grid.Column="1"
                             x:Name="TxtHoraInicio" 
                             Style="{StaticResource FieldTextBox}"
                             TabIndex="4"
                             MaxLength="5"
                             PlaceholderText="HH:mm"
                             TextChanged="OnHoraTextChanged"/>

                    <TextBlock Grid.Column="2" 
                               Text="Hora fin." 
                               Style="{StaticResource FieldLabel}"
                               Margin="0,0,4,0"/>
                    <TextBox Grid.Column="3"
                             x:Name="TxtHoraFin" 
                             Style="{StaticResource FieldTextBox}"
                             TabIndex="5"
                             MaxLength="5"
                             PlaceholderText="HH:mm"
                             TextChanged="OnHoraTextChanged"/>

                    <TextBlock Grid.Column="4" 
                               Text="Ticket" 
                               Style="{StaticResource FieldLabel}"
                               Margin="0,0,4,0"/>
                    <TextBox Grid.Column="5"
                             x:Name="TxtTicket" 
                             Style="{StaticResource FieldTextBox}"
                             TabIndex="6"
                             MaxLength="10"
                             TextChanged="OnFieldChanged"/>

                    <TextBlock Grid.Column="6" 
                               Text="Grupo" 
                               Style="{StaticResource FieldLabel}"
                               Margin="0,0,4,0"/>
                    <ComboBox Grid.Column="7"
                              x:Name="CmbGrupo"
                              Style="{StaticResource FieldComboBox}"
                              IsEditable="True"
                              TabIndex="7"
                              HorizontalAlignment="Stretch"
                              SelectionChanged="OnFieldChanged">
                    </ComboBox>

                    <TextBlock Grid.Column="8" 
                               Text="Tipo" 
                               Style="{StaticResource FieldLabel}"
                               Margin="0,0,4,0"/>
                    <ComboBox Grid.Column="9"
                              x:Name="CmbTipo"
                              Style="{StaticResource FieldComboBox}"
                              IsEditable="True"
                              TabIndex="8"
                              HorizontalAlignment="Stretch">
                    </ComboBox>

                    <TextBlock Grid.Column="10" 
                               Text="Duración" 
                               Style="{StaticResource FieldLabel}"
                               Margin="0,0,4,0"/>
                    <TextBox Grid.Column="11"
                             x:Name="TxtDuracion" 
                             Style="{StaticResource FieldTextBox}"
                             TabIndex="9"
                             MaxLength="5"
                             IsReadOnly="True"
                             IsTabStop="False"
                             TextChanged="OnFieldChanged"/>
                </Grid>

                <!-- Fila 3: Acción (campo grande multilinea) -->
                <Grid ColumnSpacing="8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Grid Grid.Column="0" VerticalAlignment="Top" Margin="0,8,0,0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" 
                                   Text="Accion" 
                                   Style="{StaticResource FieldLabel}"
                                   Margin="0,0,8,4"/>
                        <Button Grid.Row="1"
                                Background="{ThemeResource InputBg}"
                                BorderThickness="0"
                                CornerRadius="4"
                                Width="32"
                                Height="32"
                                Padding="0"
                                IsTabStop="False"
                                Margin="0,4,0,0">
                            <!-- IconHelper.Settings -->
                            <FontIcon Glyph="&#xE90F;" FontSize="16" Foreground="White"/>
                        </Button>
                    </Grid>

                    <TextBox Grid.Column="1" 
                             x:Name="TxtAccion" 
                             Background="{ThemeResource InputBg}"
                             Foreground="{ThemeResource InputText}"
                             BorderThickness="0"
                             CornerRadius="4"
                             Padding="10,8"
                             FontSize="13"
                             TextWrapping="Wrap" 
                             AcceptsReturn="True"
                             Height="100"
                             VerticalAlignment="Stretch"
                             TabIndex="10"
                             TextChanged="OnFieldChanged"/>
                </Grid>

                <!-- Campos ocultos para compatibilidad -->
                <TextBox x:Name="TxtGrupo" Visibility="Collapsed" IsTabStop="False"/>
                <TextBox x:Name="TxtTipo" Visibility="Collapsed" IsTabStop="False"/>
                <TextBox x:Name="TxtTecnico" Visibility="Collapsed" IsTabStop="False"/>
                <TextBox x:Name="TxtEstado" Visibility="Collapsed" IsTabStop="False"/>
                <Button x:Name="BtnAccionGrabar" Visibility="Collapsed" IsTabStop="False"/>

            </StackPanel>
        </ScrollViewer>

        <!-- Toolbar inferior con iconos -->
        <Border Grid.Row="2" 
                BorderBrush="{ThemeResource Accent}" 
                BorderThickness="2" 
                Padding="8" 
                CornerRadius="6" 
                Background="Transparent">
            <StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Right">
                
                <!-- Copiar -->
                <Button x:Name="BtnCopiar" 
                        Style="{StaticResource ToolbarButton}"
                        TabIndex="11"
                        Click="OnCopiarClick"
                        PointerEntered="OnButtonPointerEntered"
                        PointerExited="OnButtonPointerExited"
                        ToolTipService.ToolTip="Copiar (Ctrl+C)">
                    <StackPanel Spacing="4">
                        <!-- IconHelper.Copy -->
                        <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE8C8;" FontSize="24" Foreground="#3B82F6"/>
                        <TextBlock Text="Copiar" FontSize="11" Foreground="{ThemeResource TextMain}" HorizontalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <!-- Pegar -->
                <Button x:Name="BtnPegar" 
                        Style="{StaticResource ToolbarButton}"
                        TabIndex="12"
                        Click="OnPegarClick"
                        IsEnabled="False"
                        PointerEntered="OnButtonPointerEntered"
                        PointerExited="OnButtonPointerExited"
                        ToolTipService.ToolTip="Pegar (Ctrl+V)">
                    <StackPanel Spacing="4">
                        <!-- IconHelper.Paste -->
                        <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE77F;" FontSize="24" Foreground="{ThemeResource TextMuted}"/>
                        <TextBlock Text="Pegar" FontSize="11" Foreground="{ThemeResource TextMain}" HorizontalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <!-- Guardar -->
                <Button x:Name="BtnGuardar" 
                        Style="{StaticResource ToolbarButton}"
                        TabIndex="13"
                        Click="OnGuardarClick"
                        IsEnabled="False"
                        PointerEntered="OnButtonPointerEntered"
                        PointerExited="OnButtonPointerExited"
                        ToolTipService.ToolTip="Guardar (Ctrl+S)">
                    <StackPanel Spacing="4">
                        <!-- IconHelper.Save -->
                        <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE74E;" FontSize="24" Foreground="{ThemeResource TextMuted}"/>
                        <TextBlock Text="Grabar" FontSize="11" Foreground="{ThemeResource TextMain}" HorizontalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <!-- Cancelar -->
                <Button x:Name="BtnCancelar" 
                        Style="{StaticResource ToolbarButton}"
                        TabIndex="14"
                        Click="OnCancelarClick"
                        PointerEntered="OnButtonPointerEntered"
                        PointerExited="OnButtonPointerExited"
                        ToolTipService.ToolTip="Cancelar (Esc)">
                    <StackPanel Spacing="4">
                        <!-- IconHelper.Cancel -->
                        <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE711;" FontSize="24" Foreground="#F59E0B"/>
                        <TextBlock Text="Anular" FontSize="11" Foreground="{ThemeResource TextMain}" HorizontalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <!-- Salir -->
                <Button x:Name="BtnSalir" 
                        Style="{StaticResource ToolbarButton}"
                        TabIndex="15"
                        Click="OnSalirClick"
                        PointerEntered="OnButtonPointerEntered"
                        PointerExited="OnButtonPointerExited"
                        ToolTipService.ToolTip="Salir (Alt+F4)">
                    <StackPanel Spacing="4">
                        <!-- IconHelper.Exit -->
                        <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE7E8;" FontSize="24" Foreground="#EF4444"/>
                        <TextBlock Text="Salir" FontSize="11" Foreground="{ThemeResource TextMain}" HorizontalAlignment="Center"/>
                    </StackPanel>
                </Button>

            </StackPanel>
        </Border>

    </Grid>
</Page>
