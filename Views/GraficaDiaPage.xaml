<Page
    x:Class="GestionTime.Desktop.Views.GraficaDiaPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="using:GestionTime.Desktop.Controls"
    xmlns:models="using:GestionTime.Desktop.Models"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
    
    <Grid Padding="24,16,24,24" RowSpacing="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <!-- Controles superiores -->
        <StackPanel Orientation="Horizontal" Spacing="16">
            <CalendarDatePicker 
                x:Name="DpFecha"
                Header="Fecha"
                PlaceholderText="Selecciona un día"
                DateFormat="{}{day.integer}/{month.integer}/{year.full}"
                DateChanged="OnFechaChanged"/>
            
            <ComboBox 
                x:Name="CmbAgrupacion"
                Header="Agrupar por"
                MinWidth="150"
                SelectionChanged="OnAgrupacionChanged">
                <ComboBoxItem Content="Individual" Tag="Individual" IsSelected="True"/>
                <ComboBoxItem Content="Por Ticket" Tag="Ticket"/>
                <ComboBoxItem Content="Por Cliente" Tag="Cliente"/>
                <ComboBoxItem Content="Por Tipo" Tag="Tipo"/>
                <ComboBoxItem Content="Por Grupo" Tag="Grupo"/>
            </ComboBox>
            
            <ToggleSwitch 
                x:Name="TglSolapes"
                Header="Mostrar solapes"
                OnContent="Sí"
                OffContent="No"
                IsOn="True"
                Toggled="OnSolapesToggled"/>
            
            <Button 
                Content="Recalcular"
                Click="OnRecalcularClick"
                Style="{StaticResource AccentButtonStyle}"
                VerticalAlignment="Bottom"/>
        </StackPanel>
        
        <!-- Contenido principal -->
        <Grid Grid.Row="1" ColumnSpacing="24">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <!-- Gráfica donut estilo reloj con efecto 3D -->
            <Border 
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                CornerRadius="8"
                Padding="16"
                VerticalAlignment="Center">
                <Grid>
                    <!-- Sombra de fondo para efecto de profundidad -->
                    <Border
                        Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                        CornerRadius="200"
                        Width="400"
                        Height="400"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Opacity="0.3"
                        Margin="0,8,0,0"/>
                    
                    <controls:DonutChartControl 
                        x:Name="ChartControl"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"/>
                    
                    <!-- Centro del donut con totales en formato HH:mm -->
                    <StackPanel HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                Spacing="4"
                                Padding="0,0,0,10">
                        <TextBlock x:Name="TxtTotalTrabajado"
                                   FontSize="36"
                                   FontWeight="Bold"
                                   Foreground="#0FA7B6"
                                   HorizontalAlignment="Center"
                                   FontFamily="Consolas"/>
                        
                        <TextBlock x:Name="TxtTotalSolapado"
                                   FontSize="13"
                                   FontWeight="SemiBold"
                                   Foreground="#F59E0B"
                                   HorizontalAlignment="Center"
                                   Margin="0,2,0,0"/>
                    </StackPanel>
                    
                    <!-- Indicador de carga -->
                    <ProgressRing x:Name="LoadingRing"
                                  IsActive="False"
                                  Width="70"
                                  Height="70"
                                  HorizontalAlignment="Center"
                                  VerticalAlignment="Center"/>
                </Grid>
            </Border>
            
            <!-- Panel de métricas -->
            <ScrollViewer Grid.Column="1">
                <StackPanel Spacing="12">
                    <!-- Resumen -->
                    <Border 
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        CornerRadius="8"
                        Padding="16">
                        <StackPanel Spacing="8">
                            <TextBlock 
                                Text="Resumen del Día"
                                FontSize="18"
                                FontWeight="SemiBold"/>
                            
                            <Grid ColumnSpacing="8" RowSpacing="8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <TextBlock Grid.Row="0" Text="Tiempo trabajado:"/>
                                <TextBlock Grid.Row="0" Grid.Column="1" 
                                          x:Name="TxtMetricaTrabajado"
                                          FontWeight="Bold"
                                          FontSize="14"
                                          Foreground="#0FA7B6"/>
                                
                                <TextBlock Grid.Row="1" Text="Tiempo solapado:"/>
                                <TextBlock Grid.Row="1" Grid.Column="1" 
                                          x:Name="TxtMetricaSolapado"
                                          FontWeight="Bold"
                                          FontSize="14"
                                          Foreground="#F59E0B"/>
                                
                                <TextBlock Grid.Row="2" Text="Tiempo muerto:"/>
                                <TextBlock Grid.Row="2" Grid.Column="1" 
                                          x:Name="TxtMetricaMuerto"
                                          FontWeight="Bold"
                                          FontSize="14"
                                          Foreground="#6B7280"/>
                                
                                <TextBlock Grid.Row="3" Text="Tiempo comida:"/>
                                <TextBlock Grid.Row="3" Grid.Column="1" 
                                          Text="1h 0m"
                                          FontWeight="Bold"
                                          FontSize="14"
                                          Foreground="#9CA3AF"/>
                            </Grid>
                        </StackPanel>
                    </Border>
                    
                    <!-- Ranking -->
                    <Border 
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        CornerRadius="8"
                        Padding="16">
                        <StackPanel Spacing="8">
                            <TextBlock 
                                Text="Top Intervenciones"
                                FontSize="18"
                                FontWeight="SemiBold"/>
                            
                            <TextBlock 
                                x:Name="TxtRanking"
                                FontFamily="Consolas"
                                FontSize="11"
                                TextWrapping="Wrap"
                                LineHeight="16"/>
                        </StackPanel>
                    </Border>
                    
                    <!-- Leyenda -->
                    <Border 
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        CornerRadius="8"
                        Padding="16">
                        <StackPanel Spacing="8">
                            <TextBlock 
                                Text="Leyenda"
                                FontSize="18"
                                FontWeight="SemiBold"/>
                            
                            <ItemsRepeater x:Name="LeyendaRepeater">
                                <ItemsRepeater.ItemTemplate>
                                    <DataTemplate x:DataType="models:SegmentoGrafica">
                                        <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,4">
                                            <Rectangle 
                                                Width="16" 
                                                Height="16" 
                                                RadiusX="2"
                                                RadiusY="2">
                                                <Rectangle.Fill>
                                                    <SolidColorBrush Color="{x:Bind Color}"/>
                                                </Rectangle.Fill>
                                            </Rectangle>
                                            <StackPanel VerticalAlignment="Center">
                                                <TextBlock 
                                                    Text="{x:Bind Etiqueta}"
                                                    FontSize="12"/>
                                                <TextBlock 
                                                    FontSize="10"
                                                    Opacity="0.7">
                                                    <Run Text="{x:Bind HoraInicio}"/>
                                                    <Run Text=" - "/>
                                                    <Run Text="{x:Bind HoraFin}"/>
                                                    <Run Text=" ("/>
                                                    <Run Text="{x:Bind MinutosTotales}"/>
                                                    <Run Text="min)"/>
                                                </TextBlock>
                                            </StackPanel>
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsRepeater.ItemTemplate>
                            </ItemsRepeater>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </ScrollViewer>
        </Grid>
    </Grid>
</Page>
